<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>Flappy (Mobile)</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#0b1220; overflow:hidden; touch-action:manipulation; }
    canvas { display:block; width:100vw; height:100vh; }
    /* Safe-area padding for notches */
    .hint {
      position: fixed; left: 50%; top: env(safe-area-inset-top, 0px);
      transform: translateX(-50%);
      color: rgba(255,255,255,.9);
      font: 600 14px system-ui, -apple-system, Segoe UI, Roboto, Arial;
      padding: 10px 12px; border-radius: 999px;
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
      margin-top: 10px;
      user-select: none;
      pointer-events: none;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <canvas id="c"></canvas>
  <div class="hint" id="hint">Tap to jump • Double tap to restart</div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const hint = document.getElementById("hint");

  // HiDPI scaling
  function resize() {
    const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    canvas.width = Math.floor(window.innerWidth * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // draw in CSS pixels
  }
  window.addEventListener("resize", resize, { passive:true });
  resize();

  // Game constants (tuned for mobile)
  const GRAVITY = 2100;      // px/s^2
  const JUMP_V = -620;       // px/s
  const PIPE_SPEED = 320;    // px/s
  const PIPE_GAP = 180;      // px
  const PIPE_W = 78;         // px
  const PIPE_SPAWN = 1.15;   // seconds
  const GROUND_H = 90;       // px

  // State
  let W, H;
  let tPrev = performance.now();
  let running = false;
  let dead = false;

  const bestKey = "flappy_best_v1";
  let best = Number(localStorage.getItem(bestKey) || 0);

  const bird = {
    x: 0, y: 0, r: 16,
    vy: 0
  };

  let pipes = [];
  let score = 0;
  let spawnTimer = 0;

  function reset() {
    W = window.innerWidth;
    H = window.innerHeight;

    bird.x = Math.max(80, W * 0.28);
    bird.y = H * 0.45;
    bird.vy = 0;

    pipes = [];
    score = 0;
    spawnTimer = 0;

    dead = false;
    running = false;

    hint.textContent = "Tap to start • Tap to jump • Double tap to restart";
  }

  function rand(min, max) {
    return Math.random() * (max - min) + min;
  }

  function spawnPipe() {
    const topMin = 60;
    const topMax = H - GROUND_H - 60 - PIPE_GAP;
    const topH = rand(topMin, topMax);
    pipes.push({
      x: W + 30,
      topH,
      scored: false
    });
  }

  function jump() {
    if (dead) return;
    if (!running) {
      running = true;
      hint.textContent = "Tap to jump • Double tap to restart";
    }
    bird.vy = JUMP_V;
  }

  // Input: tap / space
  let lastTap = 0;
  function onTap() {
    const now = performance.now();
    if (now - lastTap < 300) {
      // double tap = restart
      reset();
      return;
    }
    lastTap = now;

    if (dead) { reset(); return; }
    jump();
  }

  window.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    onTap();
  }, { passive:false });

  window.addEventListener("keydown", (e) => {
    if (e.code === "Space" || e.code === "ArrowUp") {
      e.preventDefault();
      onTap();
    }
    if (e.code === "KeyR") reset();
  });

  // Collision helpers
  function circleRectCollide(cx, cy, cr, rx, ry, rw, rh) {
    const closestX = Math.max(rx, Math.min(cx, rx + rw));
    const closestY = Math.max(ry, Math.min(cy, ry + rh));
    const dx = cx - closestX;
    const dy = cy - closestY;
    return (dx*dx + dy*dy) <= cr*cr;
  }

  // Drawing
  function drawBackground() {
    // sky gradient
    const g = ctx.createLinearGradient(0, 0, 0, H);
    g.addColorStop(0, "#1b2b5a");
    g.addColorStop(1, "#0b1220");
    ctx.fillStyle = g;
    ctx.fillRect(0, 0, W, H);

    // subtle stars
    ctx.globalAlpha = 0.25;
    ctx.fillStyle = "#fff";
    for (let i = 0; i < 40; i++) {
      const x = (i * 97) % W;
      const y = (i * 151) % (H - GROUND_H);
      ctx.fillRect(x, y, 2, 2);
    }
    ctx.globalAlpha = 1;
  }

  function drawGround() {
    ctx.fillStyle = "#0f172a";
    ctx.fillRect(0, H - GROUND_H, W, GROUND_H);

    // top line
    ctx.fillStyle = "rgba(255,255,255,.12)";
    ctx.fillRect(0, H - GROUND_H, W, 2);
  }

  function drawPipes() {
    for (const p of pipes) {
      const x = p.x;
      const topH = p.topH;
      const bottomY = topH + PIPE_GAP;
      const bottomH = (H - GROUND_H) - bottomY;

      // pipe body
      ctx.fillStyle = "#22c55e";
      ctx.fillRect(x, 0, PIPE_W, topH);
      ctx.fillRect(x, bottomY, PIPE_W, bottomH);

      // pipe lip
      ctx.fillStyle = "rgba(0,0,0,.18)";
      ctx.fillRect(x, Math.max(0, topH - 12), PIPE_W, 12);
      ctx.fillRect(x, bottomY, PIPE_W, 12);

      // highlight
      ctx.fillStyle = "rgba(255,255,255,.16)";
      ctx.fillRect(x + 10, 0, 8, topH);
      ctx.fillRect(x + 10, bottomY, 8, bottomH);
    }
  }

  function drawBird() {
    // bird body
    ctx.save();
    const angle = Math.max(-0.8, Math.min(0.9, bird.vy / 700));
    ctx.translate(bird.x, bird.y);
    ctx.rotate(angle);

    ctx.fillStyle = "#fbbf24";
    ctx.beginPath();
    ctx.arc(0, 0, bird.r, 0, Math.PI * 2);
    ctx.fill();

    // wing
    ctx.fillStyle = "rgba(0,0,0,.12)";
    ctx.beginPath();
    ctx.ellipse(-2, 5, 10, 7, 0.2, 0, Math.PI * 2);
    ctx.fill();

    // eye
    ctx.fillStyle = "#0b1220";
    ctx.beginPath();
    ctx.arc(6, -4, 3.5, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.arc(7, -5, 1.3, 0, Math.PI * 2);
    ctx.fill();

    // beak
    ctx.fillStyle = "#fb7185";
    ctx.beginPath();
    ctx.moveTo(bird.r - 2, 2);
    ctx.lineTo(bird.r + 12, 0);
    ctx.lineTo(bird.r - 2, -4);
    ctx.closePath();
    ctx.fill();

    ctx.restore();
  }

  function drawUI() {
    ctx.fillStyle = "rgba(255,255,255,.92)";
    ctx.font = "700 40px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "center";
    ctx.fillText(String(score), W / 2, 90);

    ctx.font = "600 14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle = "rgba(255,255,255,.75)";
    ctx.fillText(`Best: ${best}`, W / 2, 115);

    if (!running && !dead) {
      ctx.fillStyle = "rgba(255,255,255,.92)";
      ctx.font = "800 28px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("FLAPPY", W / 2, H * 0.42);
      ctx.fillStyle = "rgba(255,255,255,.75)";
      ctx.font = "600 16px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Tap to start", W / 2, H * 0.42 + 30);
    }

    if (dead) {
      ctx.fillStyle = "rgba(0,0,0,.35)";
      ctx.fillRect(0, 0, W, H);

      ctx.fillStyle = "rgba(255,255,255,.95)";
      ctx.font = "900 32px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Game Over", W / 2, H * 0.44);

      ctx.font = "700 18px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText(`Score: ${score}   •   Best: ${best}`, W / 2, H * 0.44 + 34);

      ctx.fillStyle = "rgba(255,255,255,.8)";
      ctx.font = "600 16px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Tap to restart", W / 2, H * 0.44 + 68);
    }
  }

  // Update
  function update(dt) {
    if (!running || dead) return;

    // bird physics
    bird.vy += GRAVITY * dt;
    bird.y += bird.vy * dt;

    // spawn pipes
    spawnTimer += dt;
    if (spawnTimer >= PIPE_SPAWN) {
      spawnTimer = 0;
      spawnPipe();
    }

    // move pipes
    for (const p of pipes) p.x -= PIPE_SPEED * dt;

    // remove offscreen
    pipes = pipes.filter(p => p.x + PIPE_W > -40);

    // score when pass
    for (const p of pipes) {
      if (!p.scored && p.x + PIPE_W < bird.x - bird.r) {
        p.scored = true;
        score++;
      }
    }

    // collisions: ground/ceiling
    if (bird.y - bird.r < 0) {
      bird.y = bird.r;
      bird.vy = 0;
    }
    if (bird.y + bird.r > H - GROUND_H) {
      bird.y = H - GROUND_H - bird.r;
      die();
    }

    // collisions: pipes
    for (const p of pipes) {
      const x = p.x;
      const topH = p.topH;
      const bottomY = topH + PIPE_GAP;

      // top rect
      if (circleRectCollide(bird.x, bird.y, bird.r, x, 0, PIPE_W, topH)) { die(); break; }
      // bottom rect
      if (circleRectCollide(bird.x, bird.y, bird.r, x, bottomY, PIPE_W, (H - GROUND_H) - bottomY)) { die(); break; }
    }
  }

  function die() {
    if (dead) return;
    dead = true;
    running = false;
    best = Math.max(best, score);
    localStorage.setItem(bestKey, String(best));
    hint.textContent = "Tap to restart";
  }

  function loop(now) {
    const dt = Math.min(0.033, (now - tPrev) / 1000);
    tPrev = now;

    // update dims (in case mobile UI bars change)
    W = window.innerWidth;
    H = window.innerHeight;

    update(dt);

    // draw
    ctx.clearRect(0, 0, W, H);
    drawBackground();
    drawPipes();
    drawGround();
    drawBird();
    drawUI();

    requestAnimationFrame(loop);
  }

  reset();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
